<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SWH Console</title>
  <style>
    :root {
      --bg: #f7fafc;
      --card: #ffffff;
      --border: #d8e2ec;
      --text: #1f2d3d;
      --muted: #4a5568;
      --primary: #1f7ae0;
      --accent: #47c1bf;
      --shadow: 0 10px 28px rgba(15, 23, 42, 0.08);
    }
    body { margin:0; padding:0; font-family: 'Segoe UI', Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { padding:16px 24px; background:linear-gradient(135deg,#dff1ff,#e8f4ff); display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); flex-wrap:wrap; gap:8px; }
    h1 { margin:0; font-size:20px; }
    .container { padding:16px 24px 24px; display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:var(--shadow); display:flex; flex-direction:column; gap:8px; }
    label { display:block; margin-bottom:6px; font-weight:600; color:var(--muted); }
    input, textarea, select { width:100%; padding:12px; min-height:44px; border-radius:12px; border:1px solid var(--border); background:#f3f7fb; color:var(--text); margin-bottom:10px; }
    button { padding:12px 14px; min-height:44px; background:var(--primary); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:700; }
    pre { white-space:pre-wrap; background:#f3f7fb; padding:10px; border-radius:10px; border:1px solid var(--border); max-height:300px; overflow:auto; }
    .nudge { padding:8px; border-radius:8px; background:#eef6ff; margin-bottom:8px; border:1px solid var(--border); }
    .link { color:var(--primary); text-decoration:none; font-weight:600; }
    .stack { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .status { color:var(--muted); margin-top:6px; }
    .dev { border-top:1px dashed var(--border); padding-top:8px; margin-top:8px; display:none; }
    @media (max-width: 640px) { header { padding:14px 16px; } h1 { font-size:18px; } .container { padding:14px; grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>Smart Warranty Hub Console</h1>
    <div class="stack">
      <a class="link" href="/dashboard" target="_blank">Dashboard (built)</a>
      <a class="link" href="/dashboard-dev" target="_blank">Dashboard (dev)</a>
      <a class="link" href="/ui/scheduler" target="_blank">Scheduler</a>
    </div>
  </header>
  <div class="container">
    <div class="card">
      <h3>Inputs</h3>
      <label>User ID</label><input id="userId" value="user-1">
      <label>Warranty ID</label><input id="warrantyId" placeholder="wty_xxx">
      <label>API Key (if set)</label><input id="apiKey" placeholder="optional">
      <button onclick="loadAll()">Load</button>
      <div id="status" class="status"></div>
    </div>

    <div class="card">
      <h3>Warranty</h3>
      <div id="warranty-readable" class="helper" style="white-space:pre-wrap;"></div>
      <div id="warranty-raw-wrap">
        <pre id="warranty"></pre>
      </div>
    </div>

    <div class="card">
      <h3>Summary</h3>
      <pre id="summary"></pre>
      <div class="stack"><a class="link" id="exportTxt" target="_blank">Export TXT</a> | <a class="link" id="exportPdf" target="_blank">Export PDF</a></div>
    </div>

    <div class="card">
      <h3>Advisories</h3>
      <div id="advisories"></div>
    </div>

    <div class="card">
      <h3>Predictive</h3>
      <div id="predictive-readable" class="helper" style="white-space:pre-wrap;"></div>
      <div id="predictive-raw-wrap">
        <pre id="predictive"></pre>
      </div>
    </div>

    <div class="card">
      <h3>Upload / OCR</h3>
      <label>File</label><input id="fileInput" type="file">
      <button onclick="uploadFile()">Upload & OCR</button>
      <pre id="uploadResult"></pre>
    </div>

    <div class="card">
      <h3>OEM Fetch (reviewed)</h3>
      <label>Brand</label><input id="oemBrand">
      <label>Model</label><input id="oemModel">
      <label>Region</label><input id="oemRegion">
      <label>URL</label><input id="oemUrl">
      <button onclick="queueOem()">Queue OEM Fetch</button>
      <div id="oemStatus" class="status"></div>
    </div>

    <div class="card">
      <h3>Telemetry</h3>
      <label>Event Type</label>
      <select id="telType">
        <option value="usage">usage</option>
        <option value="error">error</option>
        <option value="failure">failure</option>
        <option value="maintenance">maintenance</option>
      </select>
      <label>Payload (JSON)</label>
      <textarea id="telPayload" rows="3" placeholder='{"hours":10}'></textarea>
      <button onclick="sendTelemetry()">Send Telemetry</button>
      <div id="telStatus" class="status"></div>
      <div id="devTools" class="dev">
        <strong>DEV tools</strong>
        <div class="stack">
          <button type="button" onclick="resetDevTelemetry()">Reset test telemetry</button>
          <button type="button" onclick="applyTelemetrySample('good')">Good telemetry</button>
          <button type="button" onclick="applyTelemetrySample('bad')">Bad telemetry</button>
        </div>
        <div class="status">Shown only when DEV_MODE=1 (?dev=1).</div>
      </div>
    </div>
  </div>
  <script>
    const DEV_MODE = Boolean(window.__DEV_MODE__) || (new URLSearchParams(window.location.search).get('dev') === '1');
    function headers(extra = {}) {
      const h = {...extra};
      const key = document.getElementById('apiKey').value.trim();
      if (key) h['X-API-Key'] = key;
      return h;
    }
    function renderMarkdown(src) {
      const lines = (src || '').split(/\r?\n/);
      const out = [];
      lines.forEach(line => {
        if (line.startsWith('###')) out.push(line.replace(/^###\s*/, '').toUpperCase());
        else if (line.startsWith('##')) out.push(line.replace(/^##\s*/, '').toUpperCase());
        else if (line.trim().startsWith('-')) out.push('• ' + line.replace(/^\-\s*/, ''));
        else out.push(line);
      });
      return out.join('\n');
    }
    function toggleRawVisibility() {
      const debug = new URLSearchParams(window.location.search).get('debug') === '1';
      const wraw = document.getElementById('warranty-raw-wrap');
      const praw = document.getElementById('predictive-raw-wrap');
      if (wraw) wraw.style.display = debug ? 'block' : 'none';
      if (praw) praw.style.display = debug ? 'block' : 'none';
    }
    toggleRawVisibility();
    async function loadAll() {
      const userId = document.getElementById('userId').value.trim();
      const warrantyId = document.getElementById('warrantyId').value.trim();
      if (!warrantyId) { document.getElementById('status').textContent = 'Enter warranty id'; return; }
      document.getElementById('status').textContent = 'Loading...';
      try {
        const w = await fetch(`/warranties/${warrantyId}`, { headers: headers() }).then(r=>r.json());
        document.getElementById('warranty').textContent = JSON.stringify(w, null, 2);
        const wread = document.getElementById('warranty-readable');
        if (wread) {
          const parts = [];
          parts.push(`Brand: ${w.brand || 'N/A'}  Model: ${w.model_code || 'N/A'}`);
          parts.push(`Expiry: ${w.expiry_date || 'N/A'}  Coverage months: ${w.coverage_months || 'N/A'}`);
          if (Array.isArray(w.terms)) parts.push('Terms:\n' + w.terms.map(t=>'• '+t).join('\n'));
          if (Array.isArray(w.exclusions)) parts.push('Exclusions:\n' + w.exclusions.map(t=>'• '+t).join('\n'));
          wread.textContent = parts.join('\n\n');
        }
        document.getElementById('exportTxt').href = `/warranties/${warrantyId}/export?format=txt`;
        document.getElementById('exportPdf').href = `/warranties/${warrantyId}/export?format=pdf`;
        const sum = await fetch('/warranties/summary', {
          method:'POST', headers: headers({'Content-Type':'application/json'}),
          body: JSON.stringify({warranty_id: warrantyId})
        }).then(r=>r.json());
        document.getElementById('summary').textContent = sum.summary || '';
        const adv = await fetch(`/advisories/${warrantyId}?user_id=${encodeURIComponent(userId)}`, { headers: headers() }).then(r=>r.json());
        document.getElementById('advisories').innerHTML = (adv.nudges||[]).map(n=>`<div class="nudge"><strong>${n.title}</strong><div>${n.message}</div></div>`).join('');
        const pred = await fetch('/predictive/score', {
          method:'POST', headers: headers({'Content-Type':'application/json'}),
          body: JSON.stringify({user_id:userId, warranty_id:warrantyId})
        }).then(r=>r.json());
        document.getElementById('predictive').textContent = JSON.stringify(pred, null, 2);
        const pread = document.getElementById('predictive-readable');
        if (pread) {
          const md = [
            `Risk label: ${pred.risk_label || pred.band || 'N/A'}`,
            `Risk score: ${pred.risk_score ?? 'N/A'}`,
            `Base: ${pred.base_risk_score ?? 'N/A'}`,
            `Behaviour delta: ${pred.behaviour_delta ?? 'N/A'}`,
            `Reasons:\n${(pred.reasons||[]).map(r=>'- '+r).join('\n')}`
          ].join('\n');
          pread.textContent = renderMarkdown(md);
        }
        document.getElementById('status').textContent = `Loaded (variant ${adv.variant || ''})`;
      } catch (err) {
        document.getElementById('status').textContent = 'Error: ' + err;
      }
    }

    async function uploadFile() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) { document.getElementById('uploadResult').textContent = 'Choose a file'; return; }
      const fd = new FormData();
      fd.append('file', file);
      fd.append('type', 'invoice');
      try {
        const res = await fetch('/artifacts/upload', { method:'POST', headers: headers(), body: fd }).then(r=>r.json());
        document.getElementById('uploadResult').textContent = JSON.stringify(res, null, 2);
      } catch (e) {
        document.getElementById('uploadResult').textContent = 'Error: ' + e;
      }
    }

    async function queueOem() {
      const brand = document.getElementById('oemBrand').value.trim();
      const model = document.getElementById('oemModel').value.trim();
      const region = document.getElementById('oemRegion').value.trim();
      const url = document.getElementById('oemUrl').value.trim();
      if (!brand || !model || !url) { document.getElementById('oemStatus').textContent = 'Fill brand, model, url'; return; }
      try {
        const res = await fetch('/oem/fetch', {
          method:'POST', headers: headers({'Content-Type':'application/json'}),
          body: JSON.stringify({brand, model, region, url, immediate:false})
        }).then(r=>r.json());
        document.getElementById('oemStatus').textContent = JSON.stringify(res);
      } catch (e) {
        document.getElementById('oemStatus').textContent = 'Error: ' + e;
      }
    }

    async function sendTelemetry() {
      const userId = document.getElementById('userId').value.trim();
      const warrantyId = document.getElementById('warrantyId').value.trim();
      const type = document.getElementById('telType').value;
      let payload;
      try { payload = JSON.parse(document.getElementById('telPayload').value || '{}'); } catch { payload = {}; }
      if (!warrantyId) { document.getElementById('telStatus').textContent = 'Set warranty id'; return; }
      try {
        return await fetch('/telemetry', {
          method:'POST', headers: headers({'Content-Type':'application/json'}),
          body: JSON.stringify({user_id:userId, warranty_id:warrantyId, event_type:type, payload})
        }).then(r=>{
          if (!r.ok) throw new Error(r.statusText);
          return r;
        });
        document.getElementById('telStatus').textContent = 'Telemetry sent';
      } catch (e) {
        document.getElementById('telStatus').textContent = 'Error: ' + e;
        throw e;
      }
    }

    function resetDevTelemetry() {
      if (!DEV_MODE) return;
      const userId = document.getElementById('userId').value.trim();
      const warrantyId = document.getElementById('warrantyId').value.trim();
      if (userId && warrantyId) {
        localStorage.removeItem(`devTelemetry:${userId}:${warrantyId}`);
      }
      document.getElementById('telStatus').textContent = 'Dev telemetry cleared locally.';
    }

    async function applyTelemetrySample(kind) {
      if (!DEV_MODE) return;
      const good = { hours: 2, errors: 0, region: "APAC" };
      const bad = { hours: 2500, errors: 8, region: "APAC" };
      const sample = kind === 'bad' ? bad : good;
      const payloadEl = document.getElementById('telPayload');
      if (payloadEl) payloadEl.value = JSON.stringify(sample, null, 2);
      try {
        await sendTelemetry();
        await loadAll();
      } catch {}
    }

    (function initDevUI(){
      const dev = document.getElementById('devTools');
      if (dev && DEV_MODE) dev.style.display = 'block';
    })();
  </script>
</body>
</html>
